#!/usr/bin/env python3


import argparse
import time
from os.path import split, splitext, join
from pygments.lexers import get_lexer_by_name, guess_lexer_for_filename
from pygments.formatters import HtmlFormatter

from modules.print_utils import print_error, print_highlight
from modules.languages import languages
from modules.process import preprocess_file, process_file
from modules.html_templates import DOCUMENT_TEMPLATE
from modules.styles import NATIVE


VERSION = "elucipy -- version 0.1 (May 2020)"
EPILOG = """Federico Maria Guercilena
(fguercilena@theorie.ikp.physik.tu-darmstadt.de)"""
DESCRIPTION = """Generate a .html document showing the source code of the
input files, with a parallel explanation running along it,
generated from the comments in the code."""

# SUPPORTED_LAGUAGES = ("python", "fortran", "c++")
SUPPORTED_LAGUAGES = ("python", "fortran", "c++")


def main():

    # Parse command line arguments
    cl_parsr = argparse.ArgumentParser(add_help=True, epilog=EPILOG,
                                       description=DESCRIPTION)

    cl_parsr.add_argument("--version", action="version", version=VERSION,
                          help="print version information and exit")

    cl_parsr.add_argument("filenames", nargs='+', help="input file(s) path")
    cl_parsr.add_argument("-l", "--language", default=None, dest="lang",
                          choices=SUPPORTED_LAGUAGES,
                          help="programming language of the input files")
    cl_parsr.add_argument("-o", "--out-directory", default=None, dest="outdir",
                          help="output directory")
    cl_parsr.add_argument("-q", "--quiet", default=False, action="store_true",
                          dest="quiet", help="quiet mode")

    args = cl_parsr.parse_args()

    if not args.quiet:
        start = time.time()

    # Setup the formatter
    formatter = HtmlFormatter(full=False, encoding="utf-8",
                              outencoding="utf-8",
                              linenos="inline", linenostart=1,
                              linenostep=1, lineanchors="line",
                              anchorlinenos=True, lineseparator="<br>")

    if args.lang is not None:
        lexer = get_lexer_by_name(args.lang, stripnl=False, stripall=False,
                                  ensurenl=True, encoding="utf-8",
                                  tabsize=languages[args.lang].tabsize)

    else:
        with open(args.filenames[0], 'r') as i:
            content = i.read()

        lexer = guess_lexer_for_filename(args.filenames[0], content,
                                         stripnl=False, stripall=False,
                                         ensurenl=True, encoding="utf-8")
        args.lang = lexer.name.lower()
        if args.lang == "numpy":
            lexer = get_lexer_by_name("python", stripnl=False, stripall=False,
                                      ensurenl=True, encoding="utf-8")
            args.lang = "python"
        elif args.lang not in SUPPORTED_LAGUAGES:
            print_error("Unsupported language (pygments guessed "
                        f"the language as '{args.lang:s}')")

        lexer.tabsize = languages[args.lang].tabsize

    if not args.quiet:
        print(f"Processing input as '{args.lang:s}' files.\n")

    # Main loop over the input files
    for filename in args.filenames:

        with open(filename, 'r') as input_file:
            content = input_file.read()

        directory, filename = split(filename)
        filename_base = splitext(filename)[0]

        if args.outdir is not None:
            directory = args.outdir

        process, content, title, intro = preprocess_file(content, filename,
                                                         languages[args.lang])

        if not process:
            if not args.quiet:
                print(f"Nothing to do for {filename:s}")
            continue

        if not args.quiet:
            print(f"Processing {filename:s}... ", end="")

        out = process_file(content, languages[args.lang], lexer, formatter)

        out = DOCUMENT_TEMPLATE.format(title, intro, out)

        outfile_path = join(directory, f"{filename_base:s}.html")
        with open(outfile_path, 'w') as output_file:
            output_file.write(out)

        style_file_path = join(directory, "native.css")
        with open(style_file_path, 'w') as style_file:
            style_file.write(NATIVE)

        if not args.quiet:
            print("Done.")

    if not args.quiet:
        stop = time.time()

        total = stop - start

        print("")
        print_highlight("All done!")
        print("")

        tmsg = f"Processed {len(args.filenames):d} files in {total:f} seconds"
        print("-"*len(tmsg))
        print(tmsg)


if __name__ == "__main__":
    main()
else:
    print_error("elucipy is not meant to be imported!")
